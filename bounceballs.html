<!DOCTYPE html>
<html>
<head>
  	<meta charset="utf-8">
  	<title>http://jsfiddle.net/inkfood/juzsR/</title>
	<style type='text/css'>
		body,html {
		    height: 100%;
		    margin:0px;
		    padding:0px;
		}

		#table {
			width: 800px;
			height: 400px;
			transform : translateZ(0); 
			/*background-color: darkgreen;*/
			background-image: url("billiard-table.png");
			background-size: 800px 400px;
			overflow: hidden;
		    margin:0px;
		    padding:0px;
		}
		#table_inner {
			border:0px solid red;
			width: 714px;
			height: 322px;
			margin-top: 39px;
			margin-left: 43px;
			background: none;
		}

		.ball {
			-webkit-transition: -webkit-transform linear;
		    -moz-transition: -moz-transform linear;
			transform : translateZ(0); 
			position: absolute;
			width: 30px;
			height: 30px;
			text-align: center;
			background:#004E99;
			border-radius:50%;
			box-shadow: -5px -5px 1px 1px rgba(0,0,0,0.1);
		}
		.ball.half:before {
			content: "";
			position: absolute;
			background: linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(255,255,255,1) 20%,rgba(255,255,255,1) 20%,rgba(255,255,255,0) 20%);
			border-radius:50%;
			bottom: 0%;
			left: 0%;
			opacity: 0.9;
			height: 30px;
			width: 30px;
			z-index: -1;
		}
		.ball.half:after {
			content: "";
			position: absolute;
			background: linear-gradient(to bottom, rgba(30,87,153,0) 0%,rgba(244,247,250,0) 80%,rgba(247,249,251,1) 80%,rgba(255,255,255,1) 80%,rgba(255,255,255,1) 100%);
			border-radius:50%;
			top: 0%;
			left: 0%;
			opacity: 0.9;
			height: 30px;
			width: 30px;
			z-index: -1;
		}

		.ball>div{
			position:absolute;
			width:100%;
			height:100%;
		}

		.ball>div>span{
			position:absolute;
			left:8px;
			top:8px;
			width:15px;
			height:15px;
			border-radius:50%;
			text-align:center;
			line-height:15px;
			font-size:12px;
			font-weight:bold;
			background:#fff;
		}

		.ball.yellow {
			background: radial-gradient(circle at 20px 20px, #fc0, #001);
		}
		.ball.blue {
			background: radial-gradient(circle at 20px 20px, #09f, #001);
		}
		.ball.red {
			background: radial-gradient(circle at 20px 20px, #f30, #001);
		}
		.ball.pink {
			background: radial-gradient(circle at 20px 20px, #80f, #001);
		}
		.ball.orange {
			background: radial-gradient(circle at 20px 20px, #f73, #001);
		}
		.ball.green {
			background: radial-gradient(circle at 20px 20px, #0f4, #001);
		}
		.ball.brown {
			background: radial-gradient(circle at 20px 20px, #a30, #001);
		}
		.ball.black {
			background: radial-gradient(circle at 20px 20px, #000, #001);
		}
		.ball.white {
			background: radial-gradient(circle at 20px 20px, #fff, #999);
		}
		.ball.white>div>span{
			background:none;
		}


	</style>

	<script type='text/javascript'>
		var ballsArray = [];
		var billardballs = [];
		var ballsize = 30;
		
		var speedLimit = 14;
		var tableheight = 322;
		var tablewidth = 714;

		var collision_friction = 0.98;
		var delta = 1 / 60;
		var friction = 1;
		var friction_active = true;

		var white_ball_dropped = false;
		var white_ball_elem = new Object();

		var mousedowntimer;
		var mousepower = 0;

		 window.requestAnimFrame = (function() {
		      return  window.requestAnimationFrame       || 
		              window.webkitRequestAnimationFrame || 
		              window.mozRequestAnimationFrame    || 
		              window.oRequestAnimationFrame      || 
		              window.msRequestAnimationFrame     || 
		              function(/* function */ callback, /* DOMElement */ element) {
		                window.setTimeout(callback, 1000 / 60);
		              };
		    })();

		function init() {
			// Create Table
			var table = document.createElement('div');
			table.id = 'table';
			document.body.appendChild(table);

			var table_inner = document.createElement('div');
			table_inner.id = 'table_inner';
			table.appendChild(table_inner);

			table.addEventListener("mousedown", function(){
				mousepower = 0;
			     mousedowntimer=setInterval(function(){
			          console.log('mousedowntimer: '+ mousepower++);
			     }, 100);
			});
			table.addEventListener("mouseup", function(e){
			    if (mousedowntimer) clearInterval(mousedowntimer)
			    mouseX = parseInt(e.clientX);
	            mouseY = parseInt(e.clientY);

	            var dx = mouseX - white_ball_elem.left;
	            var dy = mouseY - white_ball_elem.top;
// console.log(dx, dy);
	            radianAngle = Math.atan2(dy, dx);
	            xspeed = Math.cos(radianAngle) * mousepower;
	            yspeed = Math.sin(radianAngle) * mousepower;
console.log(xspeed, yspeed);
				push_white_ball(xspeed, yspeed);
				tick();
			});
			//window.onmousemove = handleMouseMove;

			
			//INIT BALLS & PHYSICS
		    initBalls();
		}

		function initBalls() {
		    
			var ball_yellow_full = new Object();
			ball_yellow_full.color = 'yellow';
			ball_yellow_full.number = '1';
			ball_yellow_full.full = true;
			ball_yellow_full.top = tableheight/2-ballsize/2;
			ball_yellow_full.left = (tablewidth/4)-ballsize/2+54;
			billardballs.push(ball_yellow_full);

			var ball_yellow_half = new Object();
			ball_yellow_half.color = 'yellow';
			ball_yellow_half.number = '9';
			ball_yellow_half.full = false;
			ball_yellow_half.top = tableheight/2-ballsize;
			ball_yellow_half.left = (tablewidth/4)-ballsize/2+27;
			billardballs.push(ball_yellow_half);

			var ball_blue_full = new Object();
			ball_blue_full.color = 'blue';
			ball_blue_full.number = '2';
			ball_blue_full.full = true;
			ball_blue_full.top = tableheight/2;
			ball_blue_full.left = (tablewidth/4)-ballsize/2+27;//173;
			billardballs.push(ball_blue_full);

			var ball_blue_half = new Object();
			ball_blue_half.color = 'blue';
			ball_blue_half.number = '10';
			ball_blue_half.full = false;
			ball_blue_half.top = tableheight/2-ballsize*1.5;
			ball_blue_half.left = (tablewidth/4)-ballsize/2;
			billardballs.push(ball_blue_half);

			var ball_red_full = new Object();
			ball_red_full.color = 'red';
			ball_red_full.number = '3';
			ball_red_full.full = true;
			ball_red_full.top = tableheight/2+ballsize/2;
			ball_red_full.left = (tablewidth/4)-ballsize/2;
			billardballs.push(ball_red_full);

			var ball_red_half = new Object();
			ball_red_half.color = 'red';
			ball_red_half.number = '11';
			ball_red_half.full = false;
			ball_red_half.top = tableheight/2-ballsize*2;
			ball_red_half.left = (tablewidth/4)-ballsize/2-27;
			billardballs.push(ball_red_half);

			var ball_pink_full = new Object();
			ball_pink_full.color = 'pink';
			ball_pink_full.number = '4';
			ball_pink_full.full = true;
			ball_pink_full.top = tableheight/2+ballsize;
			ball_pink_full.left = (tablewidth/4)-ballsize/2-27;
			billardballs.push(ball_pink_full);

			var ball_pink_half = new Object();
			ball_pink_half.color = 'pink';
			ball_pink_half.number = '12';
			ball_pink_half.full = false;
			ball_pink_half.top = tableheight/2+ballsize*1.5;
			ball_pink_half.left = (tablewidth/4)-ballsize/2-54;
			billardballs.push(ball_pink_half);

			var ball_orange_full = new Object();
			ball_orange_full.color = 'orange';
			ball_orange_full.number = '5';
			ball_orange_full.full = true;
			ball_orange_full.top = tableheight/2-ballsize*2.5;
			ball_orange_full.left = (tablewidth/4)-ballsize/2-54;
			billardballs.push(ball_orange_full);

			var ball_orange_half = new Object();
			ball_orange_half.color = 'orange';
			ball_orange_half.number = '13';
			ball_orange_half.full = false;
			ball_orange_half.top = tableheight/2-ballsize*1.5;
			ball_orange_half.left = (tablewidth/4)-ballsize/2-54;
			billardballs.push(ball_orange_half);

			var ball_green_full = new Object();
			ball_green_full.color = 'green';
			ball_green_full.number = '6';
			ball_green_full.full = true;
			ball_green_full.top = tableheight/2+ballsize/2;
			ball_green_full.left = (tablewidth/4)-ballsize/2-54;
			billardballs.push(ball_green_full);

			var ball_green_half = new Object();
			ball_green_half.color = 'green';
			ball_green_half.number = '14';
			ball_green_half.full = false;
			ball_green_half.top = tableheight/2;
			ball_green_half.left = (tablewidth/4)-ballsize/2-27;
			billardballs.push(ball_green_half);

			var ball_brown_full = new Object();
			ball_brown_full.color = 'brown';
			ball_brown_full.number = '7';
			ball_brown_full.full = true;
			ball_brown_full.top = tableheight/2-ballsize;
			ball_brown_full.left = (tablewidth/4)-ballsize/2-27;
			billardballs.push(ball_brown_full);

			var ball_brown_half = new Object();
			ball_brown_half.color = 'brown';
			ball_brown_half.number = '15';
			ball_brown_half.full = false;
			ball_brown_half.top = tableheight/2-ballsize/2;
			ball_brown_half.left = (tablewidth/4)-ballsize/2-54;
			billardballs.push(ball_brown_half);

			var ball_black_full = new Object();
			ball_black_full.color = 'black';
			ball_black_full.number = '8';
			ball_black_full.full = true;
			ball_black_full.top = tableheight/2-ballsize/2;
			ball_black_full.left = (tablewidth/4)-ballsize/2; //163 vorher 146;
			billardballs.push(ball_black_full);

			var ball_white_full = new Object();
			ball_white_full.color = 'white';
			ball_white_full.number = '';
			ball_white_full.full = true;
			ball_white_full.top = tableheight/2-ballsize/2;
			ball_white_full.left = (tablewidth/4)*3-ballsize/2;
			billardballs.push(ball_white_full);

			var minDist = window.innerHeight / billardballs.length;


			//ADD billardballs
			for (var i=0;i<billardballs.length;i++) { 
				var ball = document.createElement("div");
				if (billardballs[i].full==false) {
					ball.className = "ball half " + billardballs[i].color;	
				} else {
					ball.className = "ball " + billardballs[i].color;
				}
					
	    		var innerdiv = document.createElement('div');
	    		var innerspan = document.createElement('span');
	    		innerspan.innerHTML = billardballs[i].number;
				innerdiv.appendChild(innerspan);
				ball.appendChild(innerdiv);
				document.getElementById('table_inner').appendChild(ball);

				ball.collision = 0;
	    		ball.mass = 1;
	    		ball.color = billardballs[i].color;

				// random position and speed
				// ball.left = Math.round(Math.random()*window.innerWidth-30);
	   			// ball.top = Math.random() * (i*minDist+50 - i*minDist) + i*minDist;
	   			// ball.xspeed = Math.round(Math.random()*8);
	    		// ball.yspeed = Math.round(Math.random()*8);

	    		// defined position and speed
	   			ball.xspeed = 0;
	    		ball.yspeed = 0;
	   			ball.left = billardballs[i].left;
	            ball.top = billardballs[i].top;
				ball.style.WebkitTransform = "translate3D("+ball.left+"px,"+ball.top+"px,0px)";
	            ball.style.MozTransform = "translate3D("+ball.left+"px,"+ball.top+"px,0px)";
				
				ballsArray.push(ball);
			}

			// start with withe ball
			// push_white_ball(-27, 1);

			// loop
			tick();
			
		}

		function moveBall() {		
			for (var i=0;i<ballsArray.length;i++) { 

				// save white balls element for later
				if (ballsArray[i].color=='white') {
					white_ball_elem = ballsArray[i];
				} 

				// check boundries and holes
				if (
					(	// HOLE top left
						ballsArray[i].top<=ballsize/4
						&& ballsArray[i].left<=ballsize/4
					)
					||
					(	// HOLE top middle
						ballsArray[i].top<=0
						&& ballsArray[i].left>tablewidth/2-ballsize
						&& ballsArray[i].left<tablewidth/2
					)
					||
					(	// HOLE top right
						ballsArray[i].top<=ballsize/4
						&& ballsArray[i].left>=tablewidth-ballsize*1.25
					)
					||
					(	// HOLE bottom left
						ballsArray[i].left<=0+ballsize/4 
						&& ballsArray[i].top>=tableheight-ballsize
					)
					||
					(	// HOLE bottom middle
						ballsArray[i].top>=tableheight-ballsize
						&& ballsArray[i].left>tablewidth/2-ballsize
						&& ballsArray[i].left<tablewidth/2
					)
					||
					(	// HOLE bottom right
						ballsArray[i].top>=tableheight-ballsize*1.25
						&& ballsArray[i].left>=tablewidth-ballsize*1.25
					)
				) {
					
					if (ballsArray[i].color=='white') {
						white_ball_dropped = true;
					} 

					// remove ball
					ballsArray[i].parentNode.removeChild(ballsArray[i]);
					ballsArray.splice(i, 1);
					
					continue;
				}
				
				
				// BOUNDRIES Left
				if (ballsArray[i].left<0) {
					ballsArray[i].left = 0;
					ballsArray[i].xspeed *= -1;
					ballsArray[i].xspeed *= collision_friction;
				}
				// BOUNDRIES Right		
				if (ballsArray[i].left>tablewidth-ballsize) {
					ballsArray[i].left = tablewidth-ballsize;
					ballsArray[i].xspeed *= -1;
					ballsArray[i].xspeed *= collision_friction;
				}	
				// BOUNDRIES Top
				if (ballsArray[i].top<0) {
					ballsArray[i].top = 0;
					ballsArray[i].yspeed *= -1;
					ballsArray[i].yspeed *= collision_friction;
				}		
				// BOUNDRIES Bottom
				if (ballsArray[i].top>tableheight-ballsize) {
					ballsArray[i].top = tableheight-ballsize;
					ballsArray[i].yspeed *= -1;
					ballsArray[i].yspeed *= collision_friction;
				}	

				
				//GET THE NEW POSITION
				ballsArray[i].left += ballsArray[i].xspeed;
				ballsArray[i].top += ballsArray[i].yspeed;

				// slowing down 
				var totalspeed = Math.abs(ballsArray[i].xspeed) + Math.abs(ballsArray[i].yspeed);
// console.log(totalspeed);
				// totalspeed is mainly between 0.4 and 4
				// friction has to be between 0.95 (slow balls) and 0.99 (fast balls)
				if (totalspeed < 1) {
					friction = 0.985;
				} else if (totalspeed >1 && totalspeed <2){
					friction = 0.99;
				}else if (totalspeed >2 && totalspeed <3){
					friction = 0.991;
				}else if (totalspeed >3 && totalspeed <4){
					friction = 0.992;
				}else if (totalspeed >4 && totalspeed <50){
					friction = 0.993;
				}
				// var t = totalspeed / 100;
				// var t_friction = 0.93 + t;
// console.log(t_friction);
				if (friction_active) {
					ballsArray[i].xspeed = ballsArray[i].xspeed*friction;
					ballsArray[i].yspeed = ballsArray[i].yspeed*friction;
				}
				
				//APPLY THE NEW POSITION
				ballsArray[i].style.WebkitTransform = "translate3D("+ballsArray[i].left+"px,"+ballsArray[i].top+"px,0px)";
	            ballsArray[i].style.MozTransform = "translate3D("+ballsArray[i].left+"px,"+ballsArray[i].top+"px,0px)";
			}
		}

		
		function tick() {

		    moveBall();

		    var anyballmoving = false;
		    
		    for (var x=0; x<=ballsArray.length; x++) {
		        for (var y=x+1; y<ballsArray.length; y++) {
		        	var distance_x = Math.abs(ballsArray[x].left-ballsArray[y].left);
		        	var distance_y = Math.abs(ballsArray[x].top-ballsArray[y].top);
		        	var distance = Math.sqrt(distance_x*distance_x+distance_y*distance_y);
		        	
		        	if (distance < 20) { // sticky balls
// console.log('sticky!');
		        		ballsArray[x].collision = 0;
		                ballsArray[y].collision = 0;
		        	} else if (distance<=30 
		        		// && distance > 29
		        		&& (ballsArray[x].collision == 0 || ballsArray[y].collision == 0)
		        	) {
		        		ballsArray[x].collision = 1;
		                ballsArray[y].collision = 1;
// console.log('bounce');
		                manage_bounce(ballsArray[x], ballsArray[y]);
		        	} else if (distance>30) {
		                ballsArray[x].collision = 0;
		                ballsArray[y].collision = 0;
		            }

		            var totalspeed = Math.abs(ballsArray[y].xspeed) + Math.abs(ballsArray[y].yspeed);
// console.log(totalspeed);		        	
		        	if (totalspeed>0.1) {
			        	anyballmoving = true;
			        }
		        }
		    }

		    // play while anyball is moving
		    if (anyballmoving) {
// console.log('tick');
		    	requestAnimFrame( tick );//RUN THE NEXT TICK	
		    } else {
console.log('end');
				if (white_ball_dropped) {
					add_white_ball();	
				}
		    }
		}

		function add_white_ball() {
			white_ball_elem.top = tableheight/2-ballsize/2;
			white_ball_elem.left = (tablewidth/4)*3-ballsize/2;
			ballsArray.push(white_ball_elem);
			document.getElementById('table_inner').appendChild(white_ball_elem);
			white_ball_elem.style.WebkitTransform = "translate3D("+white_ball_elem.left+"px,"+white_ball_elem.top+"px,0px)";
	        white_ball_elem.style.MozTransform = "translate3D("+white_ball_elem.left+"px,"+white_ball_elem.top+"px,0px)";
		}

		function push_white_ball(xspeed, yspeed) {
			for (var i=0; i<ballsArray.length; i++) {
				if (billardballs[i].color=='white') {		
					ballsArray[i].xspeed = xspeed;
					ballsArray[i].yspeed = yspeed;
				}
			}
		}

		function manage_bounce(ball, ball2) {
		    dx = ball.left-ball2.left;
		    dy = ball.top-ball2.top;

		    var distance = Math.sqrt(dx*dx + dy*dy);
			if (distance<29) { //sticky!
console.log('sticky!');
				ball.left += dx;
				ball.top += dy;
			}

		    collisionision_angle = Math.atan2(dy, dx);
		    magnitude_1 = Math.sqrt(ball.xspeed*ball.xspeed+ball.yspeed*ball.yspeed);
		    magnitude_2 = Math.sqrt(ball2.xspeed*ball2.xspeed+ball2.yspeed*ball2.yspeed);
		    direction_1 = Math.atan2(ball.yspeed, ball.xspeed);
		    direction_2 = Math.atan2(ball2.yspeed, ball2.xspeed);
		    new_xspeed_1 = magnitude_1*Math.cos(direction_1-collisionision_angle);
		    new_yspeed_1 = magnitude_1*Math.sin(direction_1-collisionision_angle);
		    new_xspeed_2 = magnitude_2*Math.cos(direction_2-collisionision_angle);
		    new_yspeed_2 = magnitude_2*Math.sin(direction_2-collisionision_angle);
		    final_xspeed_1 = ((ball.mass-ball2.mass)*new_xspeed_1+(ball2.mass+ball2.mass)*new_xspeed_2)/(ball.mass+ball2.mass);
		    final_xspeed_2 = ((ball.mass+ball.mass)*new_xspeed_1+(ball2.mass-ball.mass)*new_xspeed_2)/(ball.mass+ball2.mass);
		    final_yspeed_1 = new_yspeed_1;
		    final_yspeed_2 = new_yspeed_2;
		    ball.xspeed = Math.cos(collisionision_angle)*final_xspeed_1+Math.cos(collisionision_angle+Math.PI/2)*final_yspeed_1;
		    ball.yspeed = Math.sin(collisionision_angle)*final_xspeed_1+Math.sin(collisionision_angle+Math.PI/2)*final_yspeed_1;
		    ball2.xspeed = Math.cos(collisionision_angle)*final_xspeed_2+Math.cos(collisionision_angle+Math.PI/2)*final_yspeed_2;
		    ball2.yspeed = Math.sin(collisionision_angle)*final_xspeed_2+Math.sin(collisionision_angle+Math.PI/2)*final_yspeed_2;

		    

		    // var absV = Math.abs(ball.xspeed) + Math.abs(ball2.xspeed); 
		    // overlap = (30) - Math.abs(ball.left - ball2.left); 
		    // ball.left += ball.xspeed / absV * overlap; 
		    // ball2.left += ball2.xspeed / absV * overlap; 

		    // test another elastic collision algorithm
		    // var distx = ball.left-ball2.left;
			//       var disty = ball.top-ball2.top;
			//       var dist = Math.sqrt(distx * distx + disty * disty);
			//       if (dist < 30) {
			//           var xspeed1 = ball.xspeed;
			//           var yspeed1 = ball.yspeed;
			//           var speed1 = Math.sqrt(xspeed1 * xspeed1 + yspeed1 * yspeed1);
			//           var speed2 = 0;
			//           var angle1 = Math.atan(ball.yspeed / ball.xspeed);
			//           var anglecoll1 = Math.atan(disty / distx);
			//           var anglecoll = anglecoll1 - angle1;
			//           var speed1new = speed1 * Math.abs(Math.sin(anglecoll));
			//           var speed2new = speed1 * Math.abs(Math.cos(anglecoll));
			//           if (anglecoll < 0) var angle1new = angle1 + anglecoll + Math.PI / 2;
			//           else var angle1new = angle1 + anglecoll - Math.PI / 2;
			//           var angle2new = angle1 + anglecoll;
			//           ball.xspeed = speed1new * Math.cos(angle1new);
			//           ball.yspeed = speed1new * Math.sin(angle1new);
			//           ball2.xspeed = speed2new * Math.cos(angle2new);
			//           ball2.yspeed = speed2new * Math.sin(angle2new);
			//       }

		    
		    ball.xspeed *= collision_friction;
		    ball.yspeed *= collision_friction;
		    ball2.xspeed *= collision_friction;
		    ball2.yspeed *= collision_friction;

		    // if ((ball.top <= ball2.top+(ballsize/2) && ball.left <= ball2.left+(ballsize/2)) 
		    // 	|| (ball.top >= ball2.top-(ballsize/2) && ball.left >= ball2.left+(ballsize/2))
		    // ) {
		    // 	ball.top += 1;
		    // 	ball.left += 1;
		    // }
		}

		function handleMouseMove(e) {
            e.preventDefault();
            // mouseX = parseInt(e.clientX);
            // mouseY = parseInt(e.clientY);
            // var dx = mouseX - white_ball_elem.left;
            // var dy = mouseY - white_ball_elem.top;
            // radianAngle = Math.atan2(dy, dx);
            // xspeed = Math.cos(radianAngle) * offSet;
            // yspeed = Math.sin(radianAngle) * offSet;

        }

	</script>

</head>
<body onload="init()">
</body>
</html>